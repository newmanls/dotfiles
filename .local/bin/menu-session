#!/usr/bin/env bash
# dmenu-like script for session management
# Author: Newman Sanchez (https://github.com/newmanls)

set -euo pipefail

prompt=$(uptime -p | sed -e 's/up/Uptime:/' \
    -e 's/ weeks\?/w/' \
    -e 's/ days\?/d/' \
    -e 's/ hours\?/h/' \
    -e ' s/ minutes\?/m/' \
    -e 's/,//g')

shutdown="Shutdown"
suspend="Suspend"
reboot="Reboot"
logout="Logout"
pkill="Kill process"
uefi="UEFI Firmware Settings (BIOS)"

options="${shutdown}\n${suspend}\n${reboot}\n${logout}\n${uefi}\n${pkill}"

chosen=$(printf "%b" "${options}" | $DMENU_CMD -p "${prompt}")

kill_process() {
    ps -u "$USER" -o pid,comm --no-headers | \
        $DMENU_CMD -p "Kill process" | \
        awk '{print $1}' | \
        xargs -r kill
}

case "${chosen}" in
    "$shutdown") systemctl poweroff -i ;;
    "$suspend")  systemctl suspend ;;
    "$reboot")   systemctl reboot ;;
    "$logout")   loginctl terminate-user "$(whoami)" ;;
    "$uefi")     systemctl reboot --firmware-setup ;;
    "$pkill")    kill_process ;;
esac
