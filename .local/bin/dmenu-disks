#!/usr/bin/env python3
# dmenu script for (un)mounting removable storage devices. Depends on udisks2.
# Author: Newman Sanchez (https://github.com/newmanls)

from subprocess import getoutput, run
from sys import argv

def notify(type, message):
    match type:
        case 'disk':
            icon = 'drive-removable-media'
        case 'info':
            icon = 'dialog-info'
        case 'error':
            icon = 'dialog=error'
        case _:
            icon = ''

    run(['notify-send', '-i', icon, 'udisks', message])

def print_help():
    print('Usage: dmenu-disks [mount|unmount]')
    quit(1)

try:
    action = argv[1]
except:
    print_help()

lsblk = 'lsblk -npro name,label,size,rm,fstype,mountpoint'
devices = [i.split(' ') for i in getoutput(lsblk).splitlines()]
devices = [i for i in devices if i[3] == '1' and i[4]]

match action:
    case 'mount':
        devices = [i for i in devices if not i[5]]
    case 'unmount':
        devices = [i for i in devices if i[5]]
    case _:
        print_help()

if not devices:
    notify('info', 'No devices for {}ing'.format(action))
    quit()

selected = run(['dmenu', '-p', action],
    input = '\n'.join(['{} {} ({})'.format(i[0], i[1], i[2]) for i in devices]),
    capture_output = True, text = True).stdout

if selected:
    output = run(['udisksctl', action, '-b', selected.split()[0]],
        capture_output = True)

    if output.returncode == 0:
        notify('disk', output.stdout)
    else:
        notify('error', output.stderr)
