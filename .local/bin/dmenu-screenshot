#!/usr/bin/env bash
# Simple screenshot dmenu script. Depends on imagemagick
# Author: Newman Sanchez (https://github.com/newmanls)

set -euo pipefail

gen_filename() {
    date +%Y%m%d_%H%M%S
}

is_recording() {
    pgrep ffmpeg > /dev/null 2>&1
}

start_recording() {
    ffmpeg -f x11grab \
        -i :0.0 \
        -c:v libx264 \
        -quality realtime \
        -framerate 25 \
        -profile:v baseline \
        -pix_fmt yuv420p \
        "${ssdir}/$(gen_filename).mp4" &

    notify-send -i "record-desktop" "Record started"
}

stop_recording() {
    pkill ffmpeg &&
        notify-send -i "record-desktop" "Record stopped" \
            -A "xdg-open ${filepath}"=Open \
            "Screenshot saved" \
            "You can also paste the image from the clipboard." |
            bash
}

take_screenshot() {
    filepath="${ssdir}/$(gen_filename).png"

    mkdir -p "${ssdir}"
    import -silent "${@}" "${filepath}"

    [ ! -f "${filepath}" ] && exit 1

    xclip -selection clipboard -t image/png -i "${filepath}" &&
        notify-send \
            -i "${filepath}" \
            -A "xdg-open ${filepath}"=Open \
            "Screenshot saved" \
            "You can also paste the image from the clipboard." |
            bash
}

is_recording && stop_recording && exit 0

ssdir="${HOME}/Pictures/Screenshots"
timer_delay=3

fullscreen="Fullscreen"
window="Window"
select="Select region"
timer="Timer (${timer_delay}s)"
record="Start recording"

options="${fullscreen}\n${window}\n${select}\n${timer}\n${record}"
chosen="$(printf "%b\n" "${options}" | dmenu -p "Take screenshot")"

case "${chosen}" in
    "${fullscreen}") take_screenshot -window root ;;
    "${window}")     take_screenshot -window "$(xdotool getactivewindow)" ;;
    "${select}")     take_screenshot ;;
    "${timer}")      take_screenshot -window root -pause "${timer_delay}" ;;
    "${record}")     start_recording ;;
esac
