#!/usr/bin/env bash

set -euo pipefail

roms_dir="${HOME}/Games/"
dmenu='dmenu -l 16'

lsfiles() {
    find -- * -maxdepth 0
}

select_console() {
    cd "${roms_dir}"
    console=$(lsfiles | ${dmenu} -p "play")

    IFS=' - ' read -r console_code console_name <<< "${console}"

    select_game
}

select_game() {
    cd "${console}"
    game=$(printf "..\n%s\n" "$(lsfiles)" | ${dmenu} -p "${console_name}")
    
    if [ "${game}" = ".." ]; then
        select_console
    else
        run_game
    fi
}

run_game() {
    case "${console_code}" in
        apple2|nes|snes|gb|gbc|gba|pce|lynx|md|pcfx|ngp|psx|ss|ssfplay|vb| \
        wswan|sms|gg|sasplay|snes_faust|pce_fast)
            mednafen "${game}" ;;
        *)
            notify-send -i 'dialog-error' \
                "Error" "No emulator set for '${console_name}'" && exit 1 ;;
    esac
}

select_console
